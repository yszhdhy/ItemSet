# 部署中间件

## 1、创建私有仓库：

### 1.1地址：

[容器镜像服务 (aliyun.com)](https://cr.console.aliyun.com/cn-hangzhou/instances)

### 1.2 创建个人版镜像服务

1. 选择个人版![image-20230619201202478](./部署中间件.assets/image-20230619201202478.png)
2. 创建个人版![image-20230619201220578](./部署中间件.assets/image-20230619201220578.png)
3. 设置登录密码：
4. ![image-20230619201314196](./部署中间件.assets/image-20230619201314196.png)



### 1.3 创建命名空间 也就是镜像地址

1. 创建命名空间![image-20230619202246206](./部署中间件.assets/image-20230619202246206.png)



### 1.4 创建仓库

1. 创建仓库![image-20230619202331014](./部署中间件.assets/image-20230619202331014.png)
2. 选择本地![image-20230619202042742](./部署中间件.assets/image-20230619202042742.png)





## 2、拉取arm 架构的镜像

eg：拉取arm架构的镜像

```
docker pull --platform linux/arm64 bitnami/minio:latest

docker pull --platform linux/arm64 bitnami/minio-client:latest  # 客户端
```

![image-20230619204410210](./部署中间件.assets/image-20230619204410210.png)



## 3、登录仓库并上传

### 3.1 登录阿里云

首先设置固定密码：

![image-20230619201757686](./部署中间件.assets/image-20230619201757686.png)



可以在阿里云镜像仓库复制 ：

![image-20230619201620700](./部署中间件.assets/image-20230619201620700.png)





```bash
docker login --username=aliyun4295435681 registry.cn-hangzhou.aliyuncs.com
```

![image-20230619200356691](./部署中间件.assets/image-20230619200356691.png)

### 3.2 标记镜像

参数：

1.  `3218b38490ce`  表示docker中 镜像的ID
2. `registry.cn-hangzhou.aliyuncs.com/kubesphere-xu`  表示 仓库地址
3. `kubesphere-xu`  表示 镜像名称（可自定义）
4. `minio  `   表示版本 （可自定义） 这里我们为了节省创建命名空间 直接使用镜像名称

```
docker tag 3218b38490ce registry.cn-hangzhou.aliyuncs.com/kubesphere-xu1/kubesphere-xu:minio
```

### 3.3 上传镜像

```
docker push registry.cn-hangzhou.aliyuncs.com/kubesphere-xu1/kubesphere-xu:minio
```



**注意点： minio 的客户端重复上面 标记镜像和上传镜像两步即可**



## 4、配置仓库凭证

### 4.1在项目中配置

1. ![image-20230619203116530](./部署中间件.assets/image-20230619203116530.png)
2. 选择镜像服务![image-20230619203143367](./部署中间件.assets/image-20230619203143367.png)
3. 在阿里云命名空间中 复制公网地址![image-20230619203534910](./部署中间件.assets/image-20230619203534910.png)
4. 创建![image-20230619203438915](./部署中间件.assets/image-20230619203438915.png)





## 5、通过应用商店部署中间件



### 5.1 创建应用：

1. 创建应用![image-20230619203648337](./部署中间件.assets/image-20230619203648337.png)
2. 由于之前配置过应用商店这里就不过多解释  选择bitnami 仓库 创建minio![image-20230619203750382](./部署中间件.assets/image-20230619203750382.png)
3. 安装![image-20230619203802726](./部署中间件.assets/image-20230619203802726.png)
4. 替换镜像
5. ![image-20230619204052590](./部署中间件.assets/image-20230619204052590.png)

   ```
   clientImage:
     registry: registry.cn-hangzhou.aliyuncs.com/kubesphere-xu
     repository: kubesphere-xu
     tag: minio
     digest: ""
   ```

   
6. minio 还有一个客户端 也替换![image-20230619204144286](./部署中间件.assets/image-20230619204144286.png)

   ```
   clientImage:
     registry: registry.cn-hangzhou.aliyuncs.com/kubesphere-xu
     repository: kubesphere-xu
     tag: minio-client
     digest: ""
   ```
7. 选择部署模式![image-20230619204221241](./部署中间件.assets/image-20230619204221241.png)
8. 设置用户名和密码![image-20230619204253957](./部署中间件.assets/image-20230619204253957.png)



**以上即可完成创建**

创建完成后点击到应用中可以看到有 **woker节点个** 副本 分别部署在每个节点上![image-20230619204734479](./部署中间件.assets/image-20230619204734479.png)





### 5.2暴露外网可访问

1. 创建服务：![image-20230619204831046](./部署中间件.assets/image-20230619204831046.png)
2. 名称![image-20230619204855976](./部署中间件.assets/image-20230619204855976.png)
3. 指定工作负载![image-20230619204959281](./部署中间件.assets/image-20230619204959281.png)
4. 设置端口![image-20230619205037126](./部署中间件.assets/image-20230619205037126.png)
5. 选择模式 （外网访问）![image-20230619205105543](./部署中间件.assets/image-20230619205105543.png)



以上即可完成 本次部署：

通过外网访问：![image-20230619205204519](./部署中间件.assets/image-20230619205204519.png)







